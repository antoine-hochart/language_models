import os
import pickle

from time import time

from utils.data import get_corpus, preprocess_text, list2str
from utils.eval import get_perplexity

######################################################################
# load and preprocess text

print("Loading and preprocessing text...")
t0 = time()
text = get_corpus()
(train_text, val_text, test_text), _ = preprocess_text(
    text, val_size=0.1, test_size=0.1, min_count=5, seed=0
    )
print("Done ({:.2f}s)".format(time() - t0))
print()

######################################################################
# load model

fpath = os.path.join(os.path.dirname(__file__), '..', 'data', 'models', 'ngram.pkl')
with open(fpath, 'rb') as file:
    model = pickle.load(file)

print("Best model parameters: order {}, weight {}".format(model.order, model.weight))
print()

######################################################################
# evaluate model

perplexity = get_perplexity(model, test_text)

print("Perplexity of model on test set: {:.2f}".format(perplexity))
print()

######################################################################
# sentence generator

print("Sentences generated by model:")
print()

new_text = model.generate_text(['ce', 'soir'], n_sent=5)
new_text = list2str(new_text)

print(new_text)